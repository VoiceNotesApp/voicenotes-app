<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools">

    <!-- Permissions -->
    <uses-permission android:name="android.permission.RECORD_AUDIO" />
    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
    <uses-permission android:name="android.permission.BLUETOOTH" android:maxSdkVersion="30" />
    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
    <uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"
        android:maxSdkVersion="32" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"
        android:maxSdkVersion="32"
        tools:ignore="ScopedStorage" />
    <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"
        tools:ignore="ScopedStorage" />
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
    <uses-permission android:name="android.permission.INTERNET" />
    <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- Declare that we need to query launchable apps -->
    <queries>
        <intent>
            <action android:name="android.intent.action.MAIN" />
            <category android:name="android.intent.category.LAUNCHER" />
        </intent>
    </queries>

    <application
        android:allowBackup="true"
        android:icon="@mipmap/ic_launcher"
        android:label="@string/app_name"
        android:roundIcon="@mipmap/ic_launcher_round"
        android:supportsRtl="true"
        android:theme="@style/Theme.AppCompat.Light.DarkActionBar"
        android:requestLegacyExternalStorage="true">

        <activity
            android:name=".MainActivity"
            android:launchMode="singleTask"
            android:exported="true"
            android:screenOrientation="sensor">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
            <meta-data
                android:name="android.app.shortcuts"
                android:resource="@xml/shortcuts" />
        </activity>

        <!-- SettingsActivity: Main settings interface and OAuth redirect handler
             
             OAuth Redirect URI Configuration:
             ================================
             This activity handles OAuth 2.0 redirects from OpenStreetMap authentication.
             
             Current scheme: app.voicenotes.motorcycle://oauth
             
             When registering your OAuth application at https://www.openstreetmap.org/oauth2/applications,
             use this redirect URI: app.voicenotes.motorcycle://oauth
             
             IMPORTANT: This intent-filter is attached ONLY to SettingsActivity, not to the
             SettingsLauncher activity-alias below. This ensures that only the SettingsActivity
             receives OAuth redirects, preventing Android from showing multiple app options
             during the OAuth flow.
             
             For secondary apps or debug builds:
             ===================================
             If you need to create a separate "manage" app or debug variant that also uses
             OpenStreetMap OAuth, you should:
             
             1. Use a different redirect URI scheme in your variant's AndroidManifest.xml:
                Example: app.voicenotes-manage.motorcycle://oauth
                         or: app.voicenotes.debug.motorcycle://oauth
             
             2. Update the REDIRECT_URI constant in OsmOAuthManager.kt for that variant
             
             3. Register a separate OAuth application on OpenStreetMap with the new redirect URI
             
             4. Use build flavors or variant-specific manifests to keep the configurations separate:
                - app/src/main/AndroidManifest.xml (main app)
                - app/src/debug/AndroidManifest.xml (debug variant)
                - app/src/manage/AndroidManifest.xml (manage variant, if using product flavors)
             
             This ensures each app variant has its own unique OAuth redirect handler, eliminating
             the "two icons" selection problem where users must choose which app to open.
        -->
        <activity
            android:name=".SettingsActivity"
            android:exported="true"
            android:label="@string/settings_title"
            android:parentActivityName=".MainActivity">
            <!-- OAuth 2.0 Redirect Handler for OpenStreetMap
                 ONLY this activity handles OAuth redirects - not the SettingsLauncher alias -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="app.voicenotes.motorcycle"
                    android:host="oauth" />
            </intent-filter>
        </activity>

        <!-- Activity alias for Settings launcher icon
             
             This creates a second launcher icon labeled "Voice Notes Manager" that opens
             SettingsActivity. It only handles LAUNCHER intents, NOT OAuth redirects.
             
             The OAuth intent-filter above is attached to SettingsActivity directly,
             ensuring that OAuth redirects ONLY open SettingsActivity, not this alias.
             This prevents the "two icons" selection problem during OAuth flows.
        -->
        <activity-alias
            android:name=".SettingsLauncher"
            android:targetActivity=".SettingsActivity"
            android:exported="true"
            android:label="@string/settings_launcher_name"
            android:icon="@mipmap/ic_launcher_settings"
            android:roundIcon="@mipmap/ic_launcher_settings_round">
            <!-- LAUNCHER intent-filter only - NO OAuth handling here -->
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity-alias>
        
        <activity
            android:name=".DebugLogActivity"
            android:exported="false"
            android:label="Debug Log"
            android:parentActivityName=".SettingsActivity" />
        
        <activity
            android:name=".RecordingManagerActivity"
            android:exported="true"
            android:label="Recording Manager"
            android:parentActivityName=".SettingsActivity">
            <!-- OAuth 2.0 Redirect Handler for Recording Manager -->
            <intent-filter>
                <action android:name="android.intent.action.VIEW" />
                <category android:name="android.intent.category.DEFAULT" />
                <category android:name="android.intent.category.BROWSABLE" />
                <data
                    android:scheme="app.voicenotes.motorcycle"
                    android:host="oauth"
                    android:path="/manager" />
            </intent-filter>
        </activity>
        
        <service
            android:name=".OverlayService"
            android:exported="false" />
        
        <service
            android:name=".BatchProcessingService"
            android:exported="false" />
    </application>

</manifest>
