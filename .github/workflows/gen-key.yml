# Workflow: Generate Android signing keystore (on-demand)
# Usage: Actions -> Generate Android signing keystore -> Run workflow
# After the run: download artifact 'signing-keystore', copy its base64 content into a repo secret.

name: Generate Android signing keystore

on:
  workflow_dispatch:
    inputs:
      alias:
        description: 'Key alias to use in keystore'
        required: false
        default: 'release'
      validity_days:
        description: 'Validity of key (days)'
        required: false
        default: '8250'
      dname:
        description: 'Certificate DN (e.g. CN=App,O=Org,C=US)'
        required: false
        default: 'CN=Autorecord App, O=YourOrg, C=US'

jobs:
  generate-keystore:
    name: Generate keystore and upload artifact
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Create working dir
        run: mkdir -p keystore && cd keystore && pwd

      - name: Generate a secure random password (keystore + key)
        id: genpass
        run: |
          # Create a base64-safe random password (24 chars). Adjust if you prefer different generation.
          PASS=$(openssl rand -base64 18 | tr -dc 'A-Za-z0-9' | head -c 24)
          echo "password=$PASS" >> "$GITHUB_OUTPUT"

      - name: Generate keystore (non-interactive)
        id: genks
        run: |
          set -euo pipefail
          cd keystore
          ALIAS="${{ github.event.inputs.alias }}"
          VALIDITY="${{ github.event.inputs.validity_days }}"
          DNAME="${{ github.event.inputs.dname }}"
          if [ -z "$ALIAS" ]; then ALIAS=release; fi
          if [ -z "$VALIDITY" ]; then VALIDITY=8250; fi
          # Use the same password for store and key (common pattern)
          PASS="${{ steps.genpass.outputs.password }}"
          # Generate the keystore (JKS)
          keytool -genkeypair \
            -alias "$ALIAS" \
            -keyalg RSA \
            -keysize 2048 \
            -validity "$VALIDITY" \
            -keystore release.keystore \
            -storepass "$PASS" \
            -keypass "$PASS" \
            -dname "$DNAME" \
            -storetype JKS

          # Produce base64 for safe transport/storage
          base64 release.keystore > release.keystore.base64

          echo "alias=$ALIAS" >> "$GITHUB_OUTPUT"
          echo "keystore_file=keystore/release.keystore" >> "$GITHUB_OUTPUT"
          echo "keystore_b64_file=keystore/release.keystore.base64" >> "$GITHUB_OUTPUT"

      - name: Upload keystore artifact (download once)
        uses: actions/upload-artifact@v4
        with:
          name: signing-keystore
          path: |
            keystore/release.keystore
            keystore/release.keystore.base64
          retention-days: 7

      - name: Job summary and secure storage instructions
        run: |
          echo "## ðŸ” Keystore generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Artifact name: signing-keystore" >> $GITHUB_STEP_SUMMARY
          echo "- Files: release.keystore (binary), release.keystore.base64 (base64 text)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Recommended next steps (manual, one-time):" >> $GITHUB_STEP_SUMMARY
          echo "1. Download 'release.keystore.base64' from the artifact." >> $GITHUB_STEP_SUMMARY
          echo "2. In your repository Settings â†’ Secrets â†’ Actions create these secrets:" >> $GITHUB_STEP_SUMMARY
          echo "   - SIGNING_KEYSTORE_BASE64  (paste contents of release.keystore.base64)" >> $GITHUB_STEP_SUMMARY
          echo "   - SIGNING_KEYSTORE_PASSWORD  (the generated password shown below - store securely)" >> $GITHUB_STEP_SUMMARY
          echo "   - SIGNING_KEY_ALIAS  (the alias used; default: release)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. Remove the artifact from the run if you do not want it to remain downloadable." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To add the keystore secret locally using the gh CLI (example):" >> $GITHUB_STEP_SUMMARY
          echo "  gh secret set SIGNING_KEYSTORE_BASE64 --body \"\$(cat release.keystore.base64)\"" >> $GITHUB_STEP_SUMMARY
          echo "  gh secret set SIGNING_KEYSTORE_PASSWORD --body \"${{ steps.genpass.outputs.password }}\"" >> $GITHUB_STEP_SUMMARY
          echo "  gh secret set SIGNING_KEY_ALIAS --body \"${{ steps.genks.outputs.alias }}\"" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âš ï¸ Treat these secrets as high-sensitivity credentials. After saving them to secrets, rotate or delete the uploaded artifact if desired." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated alias: ${{ steps.genks.outputs.alias }}" >> $GITHUB_STEP_SUMMARY
          echo "Generated password: ${{ steps.genpass.outputs.password }}" >> $GITHUB_STEP_SUMMARY
